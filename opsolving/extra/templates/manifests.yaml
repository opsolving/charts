{{/*
Copyright Opsolving. All Rights Reserved.
SPDX-License-Identifier: APACHE-2.0
*/}}
{{- $root := . -}}
{{- $fullname := include "common.names.fullname" $root -}}
{{- $ns := include "common.names.namespace" $root -}}
{{- $stdLabels := (include "common.labels.standard" (dict "customLabels" $root.Values.commonLabels "context" $root) | fromYaml | default (dict)) -}}
{{- $stdAnn := (include "common.tplvalues.render" ( dict "value" $root.Values.commonAnnotations "context" $root ) | fromYaml | default (dict)) -}}
{{- with $root.Values.manifests }}
{{- range $_, $group := . }}
{{- range $name, $item := $group }}
---
{{- if kindIs "map" $item }}
{{- $obj := deepCopy $item -}}
{{- $meta := (index $obj "metadata" | default (dict)) -}}
{{- $_ := set $obj "metadata" $meta -}}
{{- if $root.Values.releaseNamePrefix -}}
{{- $_ := set $meta "name" (printf "%s-%s" $fullname $name) -}}
{{- else -}}
{{- $_ := set $meta "name" $name -}}
{{- end -}}
{{- $_ := set $meta "namespace" $ns -}}
{{- /* Merge standard labels and common annotations with per-object values (object wins) */ -}}
{{- $existing := (index $meta "labels" | default (dict)) -}}
{{- $_ := set $meta "labels" (merge (deepCopy $stdLabels) (deepCopy $existing)) -}}
{{- $existingAnn := (index $meta "annotations" | default (dict)) -}}
{{- $_ := set $meta "annotations" (merge (deepCopy $stdAnn) (deepCopy $existingAnn)) -}}
{{ tpl (toYaml $obj) $root | nindent 0 }}
{{- else if kindIs "string" $item }}
{{ tpl $item $root | nindent 0 }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
